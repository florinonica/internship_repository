google.charts.load('current', {'packages':['corechart']});
google.charts.load('current', {'packages':['bar']});

google.charts.setOnLoadCallback(drawChart);
google.charts.setOnLoadCallback(drawChart1);
google.charts.setOnLoadCallback(drawChart2);
google.charts.setOnLoadCallback(drawEmployees);
var doc = new jsPDF();
var btnSave = document.getElementById('save-pdf');
doc.addHTML($("#links"), 20, 20 );
function drawChart1() {
  var data = google.visualization.arrayToDataTable([
    ['Date', 'Tickets created', 'Tickets done'],
    <% (@report.report_data['start_date'].to_date..@report.report_data['end_date'].to_date).each do |day| %>
      ['<%= day.strftime("%Y-%-m-%-d").to_s %>', <%= @report.get_filtered_by_created(day).count - @report.get_filtered_by_created(day - 1).count %>, <%= @report.get_filtered_by_ended(day).count - @report.get_filtered_by_ended(day - 1).count %>],
    <% end %>
  ]);
  var options = {
    title: 'Progress timeline',
    curveType: 'function',
    legend: { position: 'bottom' }
  };
  var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
  chart.draw(data, options);
  doc.addImage(chart.getImageURI(), 0, 125, 150, 75);
}

function drawChart2() {
  var data = google.visualization.arrayToDataTable([
    ['Ticket type', 'Number of tickets'],
    ['Tasks', <%= @report.get_tasks.count %>],
    ['Subtasks', <%= @report.get_subtasks.count %>],
    ['Bugs', <%= @report.get_bugs.count %>]
  ]);
  var options = {
    title: 'Tickets distribution'
  };
  var chart = new google.visualization.PieChart(document.getElementById('piechart'));
  function selectHandler() {
    var selectedItem = chart.getSelection()[0];
    if (selectedItem) {
      var topping = data.getValue(selectedItem.row, 0);
      if (topping == "Tasks") {
        $( "#dialog5" ).dialog();
      }
      else if (topping == "Subtasks") {
        $( "#dialog6" ).dialog();
      }
      else if (topping == "Bugs") {
        $( "#dialog7" ).dialog();
      }
    }
  }
  google.visualization.events.addListener(chart, 'select', selectHandler);
  chart.draw(data, options);
  doc.addImage(chart.getImageURI(), 125, 125, 100, 100);
}

function drawChart() {
  var data = google.visualization.arrayToDataTable([
  ['Ticket with status', 'Number of tickets'],
  ['To do', <%= @report.get_filtered_by_status("To do").count %>],
  ['In progress', <%= @report.get_filtered_by_status("In progress").count %>],
  ['Dev complete', <%= @report.get_filtered_by_status("Dev complete").count %>],
  ['Done', <%= @report.get_filtered_by_status("Done").count %>]]);
  var options = {title: "Progress status", titleTextStyle: {color: 'black', fontName: 'Ubuntu', fontSize: 20}, pieHole: 0.4, 'width':750, 'height':600,
    pieSliceTextStyle: {color: 'white', fontName: 'Ubuntu', fontSize: 18}, legendTextStyle: {color: 'black', fontName: 'Ubuntu', fontSize: 18}};
  function selectHandler() {
    var selectedItem = chart.getSelection()[0];
    if (selectedItem) {
      var topping = data.getValue(selectedItem.row, 0);
      if (topping == "To do") {
        $( "#dialog1" ).dialog();
      }
      else if (topping == "In progress") {
        $( "#dialog2" ).dialog();
      }
      else if (topping == "Dev complete") {
        $( "#dialog3" ).dialog();
      }
      else if (topping == "Done") {
        $( "#dialog4" ).dialog();
      }
    }
  }
  var chart = new google.visualization.PieChart(document.getElementById('donutchart'));
  google.visualization.events.addListener(chart, 'select', selectHandler);
  chart.draw(data, options);
  btnSave.addEventListener('click', function () {
    doc.addImage(chart.getImageURI(), 100, 20, 130, 100);
    doc.save('chart.pdf');
  }, false);
}

function drawEmployees() {
  var data = google.visualization.arrayToDataTable([
    ['Employee', 'Tickets completed', 'Total tickets'],
    <% @report.users.select{|user| user.tasks.count > 0}.each do |user| %>
      ['<%= user.full_name %>', <%= user.tasks.where(:status => 'Done').count + user.tasks.where(:status => 'Dev complete').count %>, <%= user.tasks.count %>],
    <% end %>
  ]);

  var options = {
    chart: {
      title: 'Employee Performance',
    },
    bars: 'horizontal',
  };

  var chart = new google.charts.Bar(document.getElementById('employees'));
  chart.draw(data, options);
}
